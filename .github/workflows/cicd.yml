name: CI/CD Pipeline

on:
    push:
        branches:
            - main

jobs:
    build:
        name: Build
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  submodules: true
                  fetch-depth: 0

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "25"

            - name: Install dependencies
              run: npm i

            - name: Execute build script
              run: npm run build 

            - name: Upload Build Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: build-artifact
                  path: ./build.zip
    deploy:
        name: Deploy
        needs: build
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  submodules: true
                  fetch-depth: 0

            - name: Download Build Artifact
              uses: actions/download-artifact@v4
              with:
                  name: build-artifact

            - name: Set up SSH
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.SSH_KEY }}

            - name: Deploy application
              env:
                PUBLIC_IP: ${{ secrets.PUBLIC_IP }}
              run: |
                ssh -o "StrictHostKeyChecking=no" root@$PUBLIC_IP "mkdir -p /var/www/downloads"
                scp -o 'StrictHostKeyChecking=no' ./build.zip root@$PUBLIC_IP:/var/www/downloads/build-${{ github.sha }}.zip
                ssh -o "StrictHostKeyChecking=no" root@$PUBLIC_IP "
                  set -euo pipefail
                  # Ensure DBus and XDG environment variables are set for root
                  export DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/\$(id -u root)/bus
                  export XDG_RUNTIME_DIR=/run/user/\$(id -u root)

                  # Initialize DBus session if dbus-launch is available
                  if command -v dbus-launch > /dev/null; then
                      dbus-launch --sh-syntax --exit-with-session
                  fi

                  BUILD_ID='${{ github.sha }}'
                  ZIP_PATH=\"/var/www/downloads/build-\$BUILD_ID.zip\"
                  BUILD_DIR=\"/var/www/downloads/build-\$BUILD_ID\"
                  TEMP_SETUP=\"/tmp/setup-\$BUILD_ID.sh\"

                  mkdir -p \"\$BUILD_DIR\"
                  unzip -o -qq \"\$ZIP_PATH\" -d \"\$BUILD_DIR\"
                  rm \"\$ZIP_PATH\"

                  SETUP_SRC=\"\$BUILD_DIR/setup.sh\"

                  if [ ! -f \"\$SETUP_SRC\" ]; then
                    echo \"setup.sh not found at \$SETUP_SRC\"
                    ls -R \"\$BUILD_DIR\"
                    exit 1
                  fi

                  mv \"\$SETUP_SRC\" \"\$TEMP_SETUP\"
                  chmod +x \"\$TEMP_SETUP\"
                  \"\$TEMP_SETUP\" \"\$BUILD_DIR\"
                  rm -f \"\$TEMP_SETUP\"
                "
